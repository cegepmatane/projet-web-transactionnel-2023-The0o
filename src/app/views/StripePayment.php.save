<?php

require_once('../models/PanierDAO.php');

use Stripe\Checkout\Session;
use Stripe\Stripe;
require '../../../vendor/autoload.php';

class StripePayment {

    public function __construct(readonly private string $cle) {
        Stripe::setApiKey($this->cle);
    }

    public function startPayment() {
	$panierDAO = new PanierDAO($connexion);
	$listArticle = $panierDAO->getListPanier($mailClient);
	echo $listArticle;
        $session = Session::create([
'line_items'                  => [
        array_map(fn(array $product) => [
            'quantity'   => 1,
            'price_data' => [
                'currency'     => 'EUR',
                'product_data' => [
                    'name' => $product['name']
                ],
                'unit_amount'  => $product['price']
            ]
        ], $panierDAO->getListPanier())            ],
            'mode'                        => 'payment',
            'success_url'                 => 'http://wirefit.net', //a changer manuellement
            'cancel_url'                  => 'http://localhost/poc/src/stripe.html', //a changer manuellement
            'billing_address_collection'  => 'required',
            'shipping_address_collection' => [
                'allowed_countries' => ['CA', 'FR']
            ]
        ]);
        header("HTTP/1.1 303 See Other");
        header("Location: " . $session->url);
    }
}
?>
